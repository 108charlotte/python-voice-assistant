<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JARVIS</title>

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
</head>
</head>
<body>
    <h2>JARVIS Voice Assistant</h2>
    
    <button id="record">Bother me</button>
    <br><br>
    <div id="status"></div>
    <audio id="voice" controls></audio>

    <script>
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recordBtn = document.getElementById('record');
        const statusDiv = document.getElementById('status');
        const audio = document.getElementById("voice");
        let recognition, listening = false;

        recordBtn.onclick = () => {
            if (!SpeechRecognition) {
                alert("Web Speech API not supported.");
                return;
            }
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.continuous = false;
            listening = true;
            recordBtn.disabled = true;

            recognition.onstart = () => {
                console.log("Recognition started");
                statusDiv.innerText = "Listening...";
            };

            recognition.onresult = async (event) => {
                console.log("Recognition result:", event);
                const transcript = event.results[0][0].transcript;
                statusDiv.innerText = "Processing...";
                const response = await fetch('/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transcript })
                });
                const result = await response.json();
                audio.src = result.audio_url + '?v=' + Date.now();
                audio.play();
                statusDiv.innerText = '';
            };
            recognition.onend = () => {
                console.log("Recognition ended");
                if (listening) setTimeout(() => recognition.start(), 500);
            };
            recognition.onerror = (e) => {
                console.log("Recognition error:", e);
                if (e.error === "no-speech" && listening) {
                    setTimeout(() => recognition.start(), 500);
                } else {
                    listening = false;
                    recordBtn.disabled = false;
                }
            };
            recognition.start();
        };
    </script>
</body>
</html>